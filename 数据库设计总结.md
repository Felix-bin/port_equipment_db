# 港口设备租赁管理系统 - 数据库设计总结

## 一、基本表个数：17个

### 核心业务表（9个）
1. **equipment** - 设备表
   - 存储设备基本信息、状态、价格等
   - 包含供应商、制造商、采购日期、质保期限等扩展字段

2. **customers** - 客户表
   - 存储客户基本信息、联系方式、信用评级等

3. **lease_orders** - 租赁订单表
   - 存储租赁订单主信息，关联客户和航次信息

4. **order_items** - 订单明细表
   - 存储订单中的设备明细，关联订单和设备

5. **billing** - 账单表
   - 存储费用结算信息，关联订单
   - 包含租金、维修费、折扣、支付方式等

6. **return_records** - 归还记录表
   - 存储设备归还主记录，关联订单

7. **inspection_records** - 质检记录表
   - 存储设备质检信息，关联归还记录和设备

8. **return_items** - 归还明细表
   - 存储归还设备的详细状态和损坏赔偿信息

9. **maintenance_records** - 设备维修记录表
   - 存储设备维修信息，关联设备

### 仓储管理表（4个）
10. **suppliers** - 供应商表
    - 存储供应商基本信息

11. **inbound_records** - 入库记录主表
    - 存储入库主记录

12. **inbound_items** - 入库明细表
    - 存储入库设备明细，关联入库记录和设备

13. **outbound_records** - 出库记录主表
    - 存储出库主记录，关联订单

14. **outbound_items** - 出库明细表
    - 存储出库设备明细，关联出库记录和设备

### 系统管理表（3个）
15. **users** - 用户表
    - 存储用户账号、角色、权限等信息
    - 包含扩展的个人信息字段（昵称、地址、头像等）

16. **operation_logs** - 操作日志表
    - 记录用户操作日志

17. **trigger_logs** - 触发器日志表
    - 记录触发器执行日志（预留）

---

## 二、表间是否关联：是

### 外键关联关系（共12个外键）

#### 核心业务关联
- `lease_orders.customer_id` → `customers.customer_id`
- `order_items.order_id` → `lease_orders.order_id`
- `order_items.equipment_id` → `equipment.equipment_id`
- `billing.order_id` → `lease_orders.order_id`
- `return_records.order_id` → `lease_orders.order_id`
- `inspection_records.return_id` → `return_records.return_id`
- `inspection_records.equipment_id` → `equipment.equipment_id`
- `return_items.return_id` → `return_records.return_id`
- `return_items.equipment_id` → `equipment.equipment_id`
- `maintenance_records.equipment_id` → `equipment.equipment_id`

#### 仓储管理关联
- `inbound_items.inbound_id` → `inbound_records.inbound_id`
- `inbound_items.equipment_id` → `equipment.equipment_id`
- `outbound_records.order_id` → `lease_orders.order_id`
- `outbound_items.outbound_id` → `outbound_records.outbound_id`
- `outbound_items.equipment_id` → `equipment.equipment_id`

### 关系说明
- **一对多关系**：客户→订单、订单→订单明细、订单→账单、订单→归还记录、归还记录→归还明细、归还记录→质检记录、入库记录→入库明细、出库记录→出库明细、设备→订单明细、设备→质检记录、设备→维修记录等
- **级联删除**：订单明细、归还明细、入库明细、出库明细等明细表支持级联删除
- **约束策略**：主要使用 `ON DELETE RESTRICT` 防止误删关联数据

---

## 三、视图个数：7个

已创建以下视图以优化前端界面查询性能：

### 1. v_equipment_inventory - 设备库存统计视图
- **用途**：设备库存管理界面
- **包含信息**：设备基本信息、库存状态、租赁统计（租赁次数、总租赁天数、总收入）
- **优化查询**：设备列表查询、库存统计

### 2. v_order_summary - 订单汇总视图
- **用途**：订单管理界面
- **包含信息**：订单信息、客户信息、订单明细统计、账单信息、归还信息
- **优化查询**：订单列表查询、订单详情查询

### 3. v_customer_rental_stats - 客户租赁统计视图
- **用途**：客户分析界面
- **包含信息**：客户基本信息、订单统计（总数、已完成、进行中、待提货）、财务统计（总金额、已支付、待支付）、设备统计、最近订单
- **优化查询**：客户列表查询、客户分析报表

### 4. v_billing_summary - 财务汇总视图
- **用途**：结算管理界面
- **包含信息**：账单信息、订单信息、客户信息、订单明细统计
- **优化查询**：账单列表查询、财务统计

### 5. v_equipment_usage - 设备使用情况视图
- **用途**：设备分析界面
- **包含信息**：设备基本信息、租赁统计（租赁次数、总天数、总收入、平均天数）、最近租赁、维修统计、利用率
- **优化查询**：设备使用分析、设备收益分析

### 6. v_inbound_outbound_summary - 入库出库汇总视图
- **用途**：仓储管理界面
- **包含信息**：入库/出库记录、供应商信息、操作信息、明细统计
- **优化查询**：入库出库记录查询、仓储统计

### 7. v_equipment_category_stats - 设备类别统计视图
- **用途**：设备分类统计和报表
- **包含信息**：按类别统计设备数量、库存状态分布、采购价值、平均日租金、租赁统计
- **优化查询**：设备分类分析、数据报表

---

## 四、触发器个数：11个

已创建以下触发器以实现自动化业务逻辑：

### 1. trg_order_item_insert - 订单明细插入触发器
- **触发时机**：AFTER INSERT ON order_items
- **功能**：自动更新订单总金额
- **日志记录**：记录订单明细插入操作

### 2. trg_order_item_update - 订单明细更新触发器
- **触发时机**：AFTER UPDATE ON order_items
- **功能**：自动重新计算并更新订单总金额
- **日志记录**：记录订单明细变更

### 3. trg_order_item_delete - 订单明细删除触发器
- **触发时机**：AFTER DELETE ON order_items
- **功能**：自动重新计算订单总金额
- **日志记录**：记录订单明细删除

### 4. trg_order_created - 订单创建触发器
- **触发时机**：AFTER INSERT ON lease_orders
- **功能**：自动将订单中的设备状态更新为"已出库"
- **日志记录**：记录订单创建信息

### 5. trg_return_record_created - 归还记录创建触发器
- **触发时机**：AFTER INSERT ON return_records
- **功能**：记录归还操作日志
- **日志记录**：记录归还记录创建

### 6. trg_inspection_record_created - 质检记录创建触发器
- **触发时机**：AFTER INSERT ON inspection_records
- **功能**：根据质检结果自动更新设备状态（合格→在库，需维修→维修中）
- **日志记录**：记录质检结果和设备状态变更

### 7. trg_billing_before_insert - 账单创建前触发器
- **触发时机**：BEFORE INSERT ON billing
- **功能**：自动计算账单总金额（租金+维修费+其他费用-折扣）
- **日志记录**：自动设置创建和更新时间

### 8. trg_billing_before_update - 账单更新触发器
- **触发时机**：BEFORE UPDATE ON billing
- **功能**：当费用字段变更时自动重新计算总金额
- **日志记录**：记录账单更新操作

### 9. trg_equipment_status_change - 设备状态变更触发器
- **触发时机**：AFTER UPDATE ON equipment
- **功能**：记录设备状态变更日志
- **日志记录**：记录状态变更详情（从X变更为Y）

### 10. trg_outbound_record_created - 出库记录创建触发器
- **触发时机**：AFTER INSERT ON outbound_records
- **功能**：自动将出库设备状态更新为"已出库"
- **日志记录**：记录出库操作

### 11. trg_inbound_record_created - 入库记录创建触发器
- **触发时机**：AFTER INSERT ON inbound_records
- **功能**：自动将入库设备状态更新为"在库"
- **日志记录**：记录入库操作

### 触发器优势
- ✅ **自动化处理**：减少手动操作，提高数据一致性
- ✅ **业务逻辑封装**：将业务规则封装在数据库层
- ✅ **操作日志**：自动记录关键操作，便于审计
- ✅ **数据完整性**：确保数据关联和计算的准确性

---

## 五、索引个数：约30+个

### 主键索引（17个）
每个表都有主键自动创建的主键索引

### 唯一索引（6个）
- `equipment.equipment_code` - 设备编号唯一索引
- `lease_orders.order_code` - 订单编号唯一索引
- `billing.bill_code` - 账单编号唯一索引
- `return_records.return_code` - 归还编号唯一索引
- `users.username` - 用户名唯一索引
- `suppliers.supplier_code` - 供应商编号唯一索引
- `inbound_records.inbound_code` - 入库编号唯一索引
- `outbound_records.outbound_code` - 出库编号唯一索引
- `maintenance_records.maintenance_code` - 维修编号唯一索引

### 普通索引（约15+个）
- `equipment.category` - 设备类别索引
- `equipment.status` - 设备状态索引
- `equipment.supplier` - 供应商索引
- `lease_orders.voyage_no` - 航次号索引
- `lease_orders.status` - 订单状态索引
- `billing.status` - 账单状态索引
- `billing.invoice_no` - 发票号索引
- `billing.payment_method` - 支付方式索引
- `inbound_records.status` - 入库状态索引
- `outbound_records.status` - 出库状态索引
- `maintenance_records.status` - 维修状态索引
- `users.email` - 用户邮箱索引
- `users.phone` - 用户电话索引
- `operation_logs.created_at` - 操作日志时间索引
- `trigger_logs.log_type` - 日志类型索引
- `trigger_logs.trigger_name` - 触发器名称索引
- `trigger_logs.created_at` - 日志时间索引

### 外键索引
所有外键字段自动创建索引以优化关联查询性能

---

## 六、数据库设计特点

### 1. 规范化设计
- 采用第三范式（3NF）设计，减少数据冗余
- 主从表结构清晰（订单-订单明细、入库-入库明细等）

### 2. 软删除机制
- 大部分表包含 `is_deleted` 字段，支持软删除
- 保留历史数据，便于审计和恢复

### 3. 时间戳管理
- 核心表包含 `created_at` 和 `updated_at` 字段
- 自动记录创建和更新时间

### 4. 状态管理
- 使用枚举类型管理状态字段（设备状态、订单状态、账单状态等）
- 状态流转清晰，便于业务逻辑实现

### 5. 扩展性设计
- 预留扩展字段（如设备表的供应商、制造商等）
- 支持未来业务需求扩展

### 6. 数据完整性
- 外键约束保证数据一致性
- 唯一约束防止重复数据
- 非空约束保证关键字段完整性

---

## 七、数据库统计汇总

| 项目 | 数量 | 说明 |
|------|------|------|
| **基本表个数** | 17 | 包含核心业务表、仓储管理表、系统管理表 |
| **表间是否关联** | 是 | 12个外键关联，形成完整的业务关系链 |
| **视图个数** | 7 | 已创建7个视图，优化前端界面查询性能 |
| **触发器个数** | 11 | 已创建11个触发器，实现自动化业务逻辑处理 |
| **索引个数** | 30+ | 包含主键索引、唯一索引、普通索引和外键索引 |

---

## 八、建议改进方向

1. **视图优化**：创建常用查询视图，提高查询效率
2. **触发器自动化**：实现关键业务自动化（如库存更新、费用计算）
3. **索引优化**：根据实际查询模式调整索引策略
4. **分区表**：对于大数据量表（如日志表）考虑分区
5. **备份策略**：建立定期备份机制

---

*文档生成时间：2024年*
*数据库名称：port_equipment_db*
*数据库引擎：MySQL/OceanBase (InnoDB)*

